import os
os.environ['TF_XLA_FLAGS'] = '--tf_xla_enable_xla_devices' # TODO test that this works.
os.environ["CUDA_VISIBLE_DEVICES"] = "4,5,6,7" #"0,3,4,5,6,7"

import sys
sys.path.append("../..")

import tensorflow as tf
gpus = tf.config.experimental.list_physical_devices('GPU')
for gpu in gpus:
    tf.config.experimental.set_memory_growth(gpu, True)
import numpy as np

from training.parent_train import *
from training.nm_dec_no_rs.window_train import *
from models.AttentionMasks import *
from models.NMMultiHeadAttention import NMMultiHeadAttention
from models.FeedForwardNetwork import FeedForwardNetwork
from models.PositionEncoding import get_angles, positional_encoding
from models.NMTransformerDec import NMTransformerDec
from text_processing.tokenizer import Tokenizer
from transformers import TransfoXLTokenizer
from load_datasets.language_modelling.load_wikitext import *

def get_generator(filepath="/large_data/wikitext-103/wiki.valid.tokens", load_strategy="default", load_data=[False, ""],
                  process_strategy="default_tokenize", start_tok="<s>", end_tok="</s>", pad_tok="<pad>",
                  pad=True, shuffle=True, max_seq_len=512, batch_size=4, window_size=None):

    wiki_loader = load_wikitext103(filepath=filepath, tokenizer=tokenizer, start_tok=start_tok, end_tok=end_tok,
                                   pad_tok=pad_tok, strategy=load_strategy, load_data=load_data, max_seq_len=max_seq_len)

    return wiki_loader.get_tf_dataset_generator(process_strategy, shuffle, pad, window_size).batch(batch_size)


if __name__ == "__main__":

    strategy = tf.distribute.MirroredStrategy()
    #strategy = None

    tok = TransfoXLTokenizer.from_pretrained("transfo-xl-wt103")
    tokenizer = Tokenizer(tok)
    tokenizer.add_tokens_list(["<s>", "</s>", "<pad>"], update_vocab_size_dec=True)
    tokenizer.add_tokens_list(["<dec>", "<lm>", "<confidence>"], update_vocab_size_dec=True)

    num_layers_dec, num_layers_nm = 10, 6
    d_model, num_heads, dff = 512, 8, 512*2
    max_seq_len_dec, max_seq_len_nm = 512, 512
    target_vocab_size, nm_vocab_size = tokenizer.get_vocab_size_dec(), tokenizer.get_vocab_size_dec()
    batch_size = 8*6 # last number is the number of gpus, first is the batch size per gpu.
    parallel_layers = {}
    parallel_layers["nm_attn_gate"] = ["GateLayerAttn", 3]
    parallel_layers["nm_eol_gate"] = ["NMEncoderLayerNoRC", 3]

    learning_rate = tf.keras.optimizers.schedules.ExponentialDecay(0.0001, decay_steps=1000,
                                                                   decay_rate=0.95, staircase=False, name=None)

    transformer = NMTransformerDec(num_layers_dec, num_layers_nm, d_model, num_heads, dff, max_seq_len_dec,
                                   max_seq_len_nm, target_vocab_size, nm_vocab_size, max_position_encoding_dec=2000,
                                   max_position_encoding_nm=2000, rate=0.1, nm_attn=True, nm_eol=True,
                                   parallel_layers=parallel_layers)
    optimizer = tf.keras.optimizers.Adam(learning_rate, beta_1=0.9, beta_2=0.999)

    train_class = SlidingWindowTrain(transformer, optimizer, None, None, tokenizer,
                 checkpoint_path_recent="../../checkpoints", checkpoint_path_best="", strategy=strategy, pad_token="<pad>",
                 recent_to_keep=50, load_recent=True, best_to_keep=5, load_best=False, window_size_train=32, window_size_val=32,
                 load_specific_path="")

    #string_input = "spring of 765 Du Fu and his family sailed down the Yangtze , apparently with the intention of making their way there . They traveled slowly , held up by his ill @-@ health ( by this time he was suffering from poor eyesight , deafness and general old age in addition to his previous ailments ) . They stayed in <unk> ( in what is now <unk> , Chongqing ) at the entrance to the Three Gorges for almost two years from late spring 766 . This period was Du Fu 's last great poetic flowering , and here he wrote 400 poems in his dense , late style . In autumn 766 , Bo <unk> became governor of the region : he supported Du Fu financially and employed him as his unofficial secretary . </s> In March 768 , he began his journey again and got as far as Hunan province , where he died in <unk> ( now Changsha ) in November or December 770 , in his 58th year . He was survived by his wife and two sons , who remained in the area for some years at least . His last known descendant is a grandson who requested a grave inscription for the poet from Yuan Zhen in 813 . </s> Hung summarises his life by concluding that , \" He appeared to be a filial son , an affectionate father , a generous brother , a faithful husband , a loyal friend , a dutiful official , and a patriotic subject . \" </s> Below is an example of one of Du Fu 's later works , To My Retired Friend Wei ( Chinese : <unk> ) . Like many other poems in the Tang it featured the theme of a long parting between friends , which was often due to officials being frequently transferred to the provinces : </s> = = Works = = </s> Criticism of Du Fu 's works has focused on his strong sense of history , his moral engagement , and his technical excellence . </s> = = = History = = = </s> Since the Song dynasty , critics have called Du Fu the \" poet historian \" ( <unk> <unk> <unk> ) . The most directly historical of his poems are those commenting on military tactics or the successes and failures of the government , or the poems of advice which he wrote to the emperor . Indirectly , he wrote about the effect of the times in which he lived on himself , and on the ordinary people of China . As Watson notes , this is information \" of a kind seldom found in the officially compiled histories of the era \" . </s> Du Fu 's political comments are based on emotion rather than cal"
    #string_input =  "= Valkyria Chronicles III = </s> Senj\u014d no Valkyria 3 : <unk> Chronicles ( Japanese : \u6226\u5834\u306e\u30f4\u30a1\u30eb\u30ad\u30e5\u30ea\u30a23 , lit . Valkyria of the Battlefield 3 ) , commonly referred to as Valkyria Chronicles III outside Japan , is a tactical role @-@ playing video game developed by Sega and Media.Vision for the PlayStation Portable . Released in January 2011 in Japan , it is the third game in the Valkyria series . Employing the same fusion of tactical and real @-@ time gameplay as its predecessors , the story runs parallel to the first game and follows the \" Nameless \" , a penal military unit serving the nation of Gallia during the Second Europan War who perform secret black operations and are pitted against the Imperial unit \" <unk> Raven \" . </s>"
    string_input = "The Lakers are the best team in the NBA!"
    #string_input = "= Valkyria Chronicles III = </s> Senj\u014d no Valkyria 3 : <unk> Chronicles ( Japanese : \u6226\u5834\u306e\u30f4\u30a1\u30eb\u30ad\u30e5\u30ea\u30a23 , lit . Valkyria of the Battlefield 3 ) , commonly referred to as Valkyria Chronicles III outside Japan , is a tactical role @-@ playing video game developed by Sega and Media.Vision for the PlayStation Portable . Released in January 2011 in Japan , it is the third game in the Valkyria series . Employing the same fusion of tactical and real @-@ time gameplay as its predecessors , the story runs parallel to the first game and follows the \" Nameless \" , a penal military unit serving the nation of Gallia during the Second Europan War who perform secret black operations and are pitted against the Imperial unit \" <unk> Raven \" . </s> The game began development in 2010 , carrying over a large portion of the work done on Valkyria Chronicles II . While it retained the standard features of the series , it also underwent multiple adjustments , such as making the game more forgiving for series newcomers . Character designer <unk> Honjou and composer Hitoshi Sakimoto both returned from previous entries , along with Valkyria Chronicles II director Takeshi Ozawa . A large team of writers handled the script . The game 's opening theme was sung by May 'n . </s> It met with positive sales in Japan , and was praised by both Japanese and western critics . After release , it received downloadable content , along with an expanded edition in November of that year . It was also adapted into manga and an original video animation series . Due to low sales of Valkyria Chronicles II , Valkyria Chronicles III was not localized , but a fan translation compatible with the game 's expanded edition was released in 2014 . Media.Vision would return to the franchise with the development of Valkyria : Azure Revolution for the PlayStation 4 . </s> = = Gameplay = = </s> As with previous <unk> Chronicles games , Valkyria Chronicles III is a tactical role @-@ playing game where players take control of a military unit and take part in missions against enemy forces . Stories are told through comic book @-@ like panels with animated character portraits , with characters speaking partially through voiced speech bubbles and partially through unvoiced text . The player progresses through a series of linear missions , gradually unlocked as maps that can be freely scanned through and"
    #string_input = " = = = First three @-@ peat ( 1991 \u2013 1993 ) = = = </s> In the 1990 \u2013 91 season , Jordan won his second MVP award after averaging 31 @.@ 5 ppg on 53 @.@ 9 % shooting , 6 @.@ 0 rpg , and 5 @.@ 5 apg for the regular season . The Bulls finished in first place in their division for the first time in 16 years and set a franchise record with 61 wins in the regular season . With Scottie Pippen developing into an All @-@ Star , the Bulls had elevated their play . The Bulls defeated the New York Knicks and the Philadelphia 76ers in the opening two rounds of the playoffs . They advanced to the Eastern Conference Finals where their rival , the Detroit Pistons , awaited them . However , this time the Bulls beat the Pistons in a four @-@ game sweep . In an unusual ending to the fourth and final game , Isiah Thomas led his team off the court before the final seconds had concluded . Most of the Pistons went directly to their locker room instead of shaking hands with the Bulls . </s> The Bulls advanced to the NBA Finals for the first time in franchise history to face Magic Johnson and James Worthy and beat the Los Angeles Lakers four games to one , compiling an outstanding 15 \u2013 2 playoff record along the way . Perhaps the best known moment of the series came in Game 2 when , attempting a dunk , Jordan avoided a potential Sam Perkins block by switching the ball from his right hand to his left in mid @-@ air to lay the shot in . In his first Finals appearance , Jordan posted per game averages of 31 @.@ 2 points on 56 % shooting from the field , 11 @.@ 4 assists , 6 @.@ 6 rebounds , 2 @.@ 8 steals and 1 @.@ 4 blocks . Jordan won his first NBA Finals MVP award , and he cried while holding the NBA Finals trophy . </s> Jordan and the Bulls continued their dominance in the 1991 \u2013 92 season , establishing a 67 \u2013 15 record , topping their franchise record from 1990 to 91 . Jordan won his second consecutive MVP award with averages of 30 @.@ 1 points , 6 @.@ 4 rebounds and 6 @.@ 1 assists per game on 52 % shooting . After winning a physical 7 @-@ game series over the New York Knicks in the second round of the playoffs and finishing off the Cleveland Cavaliers"
    #string_input = "Furthermore , his poems use a wide range of registers , from the direct and colloquial to the allusive and self @-@ consciously literary . This variety is manifested even within individual works : Owen identifies the , \" rapid stylistic and thematic shifts \" in poems which enable the poet to represent different facets of a situation , while Chou uses the term \" juxtaposition \" as the major analytical tool in her work . Du Fu is noted for having written more on poetics and painting than any other writer of his time . He wrote eighteen poems on painting alone , more than any other Tang poet . Du Fu 's seemingly negative commentary on the prized horse paintings of Han Gan ignited a controversy that has persisted to the present day . </s> The tenor of his work changed as he developed his style and adapted to his surroundings ( \" chameleon @-@ like \" according to Watson ) : his earliest works are in a relatively derivative , courtly style , but he came into his own in the years of the rebellion . Owen comments on the \" grim simplicity \" of the <unk> poems , which mirrors the desert landscape ; the works from his Chengdu period are \" light , often finely observed \" ; while the poems from the late <unk> period have a \" density and power of vision \" . </s> Although he wrote in all poetic forms , Du Fu is best known for his <unk> , a type of poem with strict constraints on form and content , for example : </s> About two thirds of Du Fu 's 1500 extant works are in this form , and he is generally considered to be its leading exponent . His best <unk> use the <unk> required by the form to add expressive content rather than as mere technical restrictions . Hawkes comments that , \" it is amazing that Tu Fu is able to use so immensely stylized a form in so natural a manner \" . </s> = = Influence = = </s> According to the Encyclop\u00e6dia Britannica , Du Fu 's writings are considered by many literary critics to be among the greatest of all time , and it states \" his dense , compressed language makes use of all the connotative overtones of a phrase and of all the <unk> potentials of the individual word , qualities that no translation can ever reveal . \" </s> In his lifetime and immediately following his death , Du Fu was not greatly appreciated . In part this can be attributed to his stylistic and formal innovations , some of which are still \" considered extremely daring and bizarre by Chinese critics . \" There are few contemporary references to him \u2014 only eleven poems from six writers \u2014"
    #string_input = " = Robert Boulter = </s> Robert Boulter is an English film , television and theatre actor . He had a guest @-@ starring role on the television series The Bill in 2000 . This was followed by a starring role in the play Herons written by Simon Stephens , which was performed in 2001 at the Royal Court Theatre . He had a guest role in the television series Judge John Deed in 2002 . In 2004 Boulter landed a role as \" Craig \" in the episode \" Teddy 's Story \" of the television series The Long Firm ; he starred alongside actors Mark Strong and Derek Jacobi . He was cast in the 2005 theatre productions of the Philip Ridley play Mercury Fur , which was performed at the Drum Theatre in Plymouth and the <unk> Chocolate Factory in London . He was directed by John Tiffany and starred alongside Ben Whishaw , Shane Zaza , Harry Kent , Fraser Ayres , Sophie Stanton and Dominic Hall . </s> In 2006 , Boulter starred alongside Whishaw in the play Citizenship written by Mark Ravenhill . He appeared on a 2006 episode of the television series , Doctors , followed by a role in the 2007 theatre production of How to Curse directed by Josie Rourke . How to Curse was performed at Bush Theatre in the London Borough of Hammersmith and Fulham . Boulter starred in two films in 2008 , Daylight Robbery by filmmaker Paris <unk> , and Donkey Punch directed by Olly Blackburn . In May 2008 , Boulter made a guest appearance on a two @-@ part episode arc of the television series Waking the Dead , followed by an appearance on the television series Survivors in November 2008 . He had a recurring role in ten episodes of the television series Casualty in 2010 , as \" Kieron Fletcher \" . Boulter starred in the 2011 film Mercenaries directed by Paris <unk> . </s> = = Career = = </s> = = = 2000 \u2013 2005 = = = </s> In 2000 Boulter had a guest @-@ starring role on the television series The Bill ; he portrayed \" Scott Parry \" in the episode , \" In Safe Hands \" . Boulter starred as \" Scott \" in the play Herons written by Simon Stephens , which was performed in 2001 at the Royal Court Theatre . A review of Boulter 's performance in The Independent on Sunday described him as \" horribly menacing \" in the role , and he received critical reviews in The Herald , and Evening Standard . He appeared in the television series Judge John Deed in 2002 as \" <unk> Armitage \" in the episode \" Political <unk> \" , and had a role as a different character \" Toby Steele \" on The Bill . </s> He had a recurring role in 2003 on two episodes of The Bill , as character \" Connor Price \" . In 2004 Boulter landed a role as \" Craig \" in the episode \" Teddy 's Story \" of the television series The Long Firm ; he starred alongside actors Mark Strong and Derek Jacobi . Boulter starred as \" Darren \" , in the 2005 theatre productions of the Philip Ridley play Mercury Fur . It was performed at the Drum Theatre in Plymouth , and the <unk> Chocolate Factory in London . He was directed by John Tiffany and starred alongside Ben Whishaw , Shane Zaza , Harry Kent , Fraser Ayres , Sophie Stanton and Dominic Hall . Boulter received a favorable review in The Daily Telegraph : \" The acting is shatteringly intense , with wired performances from Ben Whishaw ( now unrecognisable from his performance as Trevor Nunn 's Hamlet ) , Robert Boulter , Shane Zaza and Fraser Ayres . \" The Guardian noted , \" Ben Whishaw and Robert Boulter offer tenderness amid the savagery . \" </s> = = = 2006 \u2013 present = = = </s> In 2006 Boulter starred in the play Citizenship written by Mark Ravenhill . The play was part of a series which featured different playwrights , titled Burn / <unk> / Citizenship . In a 2006 interview , fellow actor Ben Whishaw identified Boulter as one of his favorite co @-@ stars : \" I loved working with a guy called Robert Boulter , who was in the triple bill of Burn , <unk> and Citizenship at the National . He played my brother in Mercury Fur . \" He portrayed \" Jason Tyler \" on the 2006 episode of the television series , Doctors , titled \" Something I Ate \" . Boulter starred as \" William \" in the 2007 production of How to Curse directed by Josie Rourke . How to Curse was performed at Bush Theatre in the London Borough of Hammersmith and Fulham . In a review of the production for The Daily Telegraph , theatre critic Charles Spencer noted , \" Robert Boulter brings a touching vulnerability to the stage as William . \" </s> Boulter starred in two films in 2008 , Daylight Robbery by filmmaker Paris <unk> , and Donkey Punch directed by Olly Blackburn . Boulter portrayed a character named \" Sean \" in Donkey Punch , who tags along with character \" Josh \" as the \" quiet brother ... who hits it off with Tammi \" . Boulter guest starred on a two @-@ part episode arc \" Wounds \" in May 2008 of the television series Waking the Dead as character \" Jimmy Dearden \" . He appeared on the television series Survivors as \" Neil \" in November 2008 . He had a recurring role in ten episodes of the television series Casualty in 2010 , as \" Kieron Fletcher \" . He portrayed an emergency physician applying for a medical fellowship . He commented on the inherent difficulties in portraying a physician on television : \" Playing a doctor is a strange experience . Pretending you know what you 're talking about when you don 't is very bizarre but there are advisers on set who are fantastic at taking you through procedures and giving you the confidence to stand there and look like you know what you 're doing . \" Boulter starred in the 2011 film Mercenaries directed by Paris <unk> . </s> = = Filmography = = </s> = = = Film = = = </s> = = = Television = = = </s> = = = Theatre = = = </s>"
    #string_input = "Kershaw started the 2010 season by posting a 3.07 ERA in April, but did so by walking 22 batters in 29 innings.  On May 4, he had his worst start of his career against the Milwaukee Brewers at Dodger Stadium, throwing just 57 pitches in 11 / 3 innings, while retiring only four of the 13 batters he faced — including the pitcher.  He was booed loudly upon being pulled from the game.  Kershaw said after the game, \" I didn’t give our team any kind of chance.  It’s just not a goodfeeling to let your teammates down, let everybody down. It stings, it hurts. I ’ve got to figure things out. \" Kershaw rebounded his next start by pitching an 8 inning two-hitter and out-dueling the then undefeated Ubaldo Jiménez. He credited his control of the slider being the major turning point for him. Later in the season, hewas suspended for five games after hitting Aaron Rowand of the Giants with a pitch in a game on July 20.  The incident occurred after both teams were given awarning following Giants ace Tim Lincecum hitting Matt Kemp earlier in the game.  He threw his first career complete game shutout on September 14, 2010 also against San Francisco and finished the season with a record of 13 – 10 and a 2.91 ERA in 32 starts, pitching 2041 / 3 innings and recording 212 strikeouts. = = = = 2011 season: 1st Cy Young Award = = = = After finishing the 2010 season strong, the Dodgers named Kershaw as the Opening Day Starter for the 2011 season. On May 29, he pitched the second complete game shutout of his career, striking out 10 while winning a two-hitter against the Florida Marlins, 8 – 0; he also had two singles and an RBI, scoring twice in the game. He produced his third career shutout on June 20, a two-hit, 11 strikeout effort against the Detroit Tigers. Kershaw became the first Dodgers starter to strikeout the side in the 9th inning since Sandy Koufax’s perfect game.  In his next start, on June 26, Kershaw pitched another complete game (against the Los Angeles Angels of Anaheim ). He became the first Dodger starter to have back-to-back complete game victories since Jeff Weaver in the 2005 season and the first Dodger to have double-digit strikeouts in consecutive starts since Chan-Ho Park in the 2000 season. He was awarded the National League Player of the Week award for the week of June 20 – 26 as a result of those two starts. Midway through June, Kershaw had amassed 32 career victories"
    pad_to_length = 512
    num_aux_tokens = 0
    num_to_generate = 50

    full_text, original, new = train_class.generate_natural_language_top_k(string_input, pad_to_length, num_aux_tokens, num_to_generate, k=40)
    print(f"Generated (full) text results:\n {full_text} \n\n Original text:\n {original} \n\n Newly generated text:\n {new} \n")




